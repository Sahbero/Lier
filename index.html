<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gizemli Bağ - Ruh Eşi Algoritması</title>
    
    <!-- Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        @keyframes bounce-in { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        .animate-bounce-in { animation: bounce-in 0.6s cubic-bezier(0.215, 0.610, 0.355, 1.000); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #db2777; border-radius: 20px; }
    </style>
</head>
<body class="bg-[#09090b] text-white font-sans selection:bg-pink-500 selection:text-white overflow-x-hidden">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- FIREBASE MODÜLLERİ ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, getDoc,
            query, where, getDocs, deleteDoc, setDoc, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ==================================================================
        // FIREBASE AYARLARI (Senin Bilgilerin)
        // ==================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyC67niOAv8lLVAlDDRVSCQFTdyJO2eMn94",
            authDomain: "lier-db123.firebaseapp.com",
            projectId: "lier-db123",
            storageBucket: "lier-db123.firebasestorage.app",
            messagingSenderId: "637814349438",
            appId: "1:637814349438:web:c670c3e13dd5bd28a6422f",
            measurementId: "G-FLFVH8Z4R9"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase başlatma hatası:", e);
        }
        
        const APP_ID = "mystery-connection-v3"; 

        // --- IKON BİLEŞENİ ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        root: iconRef.current,
                        nameAttr: 'data-name',
                        attrs: { class: `lucide lucide-${name} ${className}`, width: size, height: size }
                    });
                }
            }, [name, size, className]);
            return <span ref={iconRef} data-name={name} className="inline-flex items-center justify-center"></span>;
        };

        // --- SABİTLER ---
        const GAME_STATES = {
            PROFILE: 'PROFILE',
            LOBBY: 'LOBBY',
            SEARCHING: 'SEARCHING',
            MATCH_FOUND: 'MATCH_FOUND',
            CHAT: 'CHAT',
            GUESS_LEVEL: 'GUESS_LEVEL',
            GUESS_CRITERIA: 'GUESS_CRITERIA',
            RESULT: 'RESULT'
        };

        const MATCH_LEVELS = [
            { id: 0, minScore: 0, maxScore: 0, label: "Farklı Dünyaların İnsanı", color: "text-gray-500", desc: "Hiçbir ortak noktanız yok." },
            { id: 1, minScore: 1, maxScore: 1, label: "Tesadüfi Benzerlik", color: "text-blue-400", desc: "Sadece tek bir noktada buluştunuz." },
            { id: 2, minScore: 2, maxScore: 2, label: "Ortak Frekans", color: "text-green-400", desc: "Benzer zevklere sahipsiniz." },
            { id: 3, minScore: 3, maxScore: 3, label: "Güçlü Bağ", color: "text-purple-400", desc: "Birçok konuda hemfikirsiniz." },
            { id: 4, minScore: 4, maxScore: 12, label: "Ruh Eşi", color: "text-pink-500", desc: "İnanılmaz! Neredeyse aynısınız." }
        ];

        const QUESTIONS = [
            { id: 'color', label: 'En sevdiğin renk?', iconName: 'zap', options: ['Mavi', 'Kırmızı', 'Siyah', 'Yeşil', 'Sarı', 'Mor', 'Turuncu', 'Beyaz'] },
            { id: 'food', label: 'En sevdiğin yemek?', iconName: 'heart', options: ['Pizza', 'Burger', 'Sushi', 'Kebap', 'Makarna', 'Salata', 'Tatlı', 'Mantı'] },
            { id: 'toy', label: 'Çocukken en sevdiğin oyuncak?', iconName: 'ghost', options: ['Lego', 'Barbie', 'Araba', 'Peluş', 'Action Man', 'Top', 'Gameboy', 'Puzzle'] },
            { id: 'music', label: 'Müzik türün?', iconName: 'music', options: ['Pop', 'Rock', 'Rap', 'Klasik', 'Jazz', 'Elektronik', 'Indie', 'Metal'] },
            { id: 'person', label: 'Değerli insan tipi?', iconName: 'user', options: ['Aile', 'Dost', 'Sevgili', 'Kendim', 'Mentor', 'Evcil Hayvan'] },
            { id: 'fear', label: 'En büyük korkun?', iconName: 'frown', options: ['Yalnızlık', 'Yükseklik', 'Böcek', 'Başarısızlık', 'Karanlık', 'Ölüm', 'Palyaço'] },
            { id: 'excitement', label: 'Seni ne heyecanlandırır?', iconName: 'smile', options: ['Seyahat', 'Para', 'Aşk', 'Yemek', 'Adrenalin', 'Öğrenmek'] },
            { id: 'talent', label: 'İstediğin yetenek?', iconName: 'star', options: ['Uçmak', 'Görünmezlik', 'Zihin Okuma', 'Zamanı Durdurma', 'Işınlanma'] },
            { id: 'film', label: 'En sevdiğin film türü?', iconName: 'film', options: ['Bilim Kurgu', 'Romantik', 'Korku', 'Komedi', 'Aksiyon', 'Belgesel', 'Animasyon'] },
            { id: 'book', label: 'En sevdiğin kitap türü?', iconName: 'book', options: ['Roman', 'Kişisel Gelişim', 'Tarih', 'Fantastik', 'Polisiye', 'Şiir'] },
            { id: 'item', label: 'Vazgeçilmez eşyan?', iconName: 'coffee', options: ['Telefon', 'Kulaklık', 'Bilgisayar', 'Saat', 'Gözlük', 'Defter'] },
            { id: 'trait', label: 'En sevdiğin özelliğin?', iconName: 'sparkles', options: ['Zeka', 'Mizah', 'Sabır', 'Cesaret', 'Dürüstlük', 'Sadakat'] }
        ];

        function MysteryConnectionGame() {
            const { useState, useEffect, useRef } = React;
            
            const [user, setUser] = useState(null);
            const [authError, setAuthError] = useState(null);
            const [gameState, setGameState] = useState(GAME_STATES.PROFILE);
            const [userProfile, setUserProfile] = useState({ name: '', age: '' });
            const [opponentProfile, setOpponentProfile] = useState({});
            const [matchLevel, setMatchLevel] = useState(null);
            const [sharedCategories, setSharedCategories] = useState([]);
            
            const [gameId, setGameId] = useState(null);
            const [currentTurn, setCurrentTurn] = useState(null); // KİMİN SIRASI?
            const [onlineCount, setOnlineCount] = useState(0);
            const unsubscribeGameRef = useRef(null);

            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState("");
            const [systemMessage, setSystemMessage] = useState(null);
            
            const [guessedLevel, setGuessedLevel] = useState(null);
            const [guesses, setGuesses] = useState({});
            const chatEndRef = useRef(null);

            // 1. AUTHENTICATION
            useEffect(() => {
                if (!auth) return;
                signInAnonymously(auth).catch(err => setAuthError({ title: "Giriş Hatası", msg: err.message }));
                const unsubscribe = onAuthStateChanged(auth, (u) => { if (u) setUser(u); });
                return () => unsubscribe();
            }, []);

            // 2. ONLINE SAYISI
            useEffect(() => {
                if (!user) return;
                const updatePresence = () => {
                    const presenceRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'presence', user.uid);
                    setDoc(presenceRef, { lastSeen: serverTimestamp(), userId: user.uid }, { merge: true });
                };
                updatePresence();
                const interval = setInterval(updatePresence, 30000);
                const presenceColl = collection(db, 'artifacts', APP_ID, 'public', 'data', 'presence');
                const unsubPresence = onSnapshot(presenceColl, (snapshot) => {
                    const now = new Date();
                    setOnlineCount(snapshot.docs.filter(d => d.data().lastSeen && (now - d.data().lastSeen.toDate()) < 120000).length);
                });
                return () => { clearInterval(interval); unsubPresence(); };
            }, [user]);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            // PROFIL VALIDATION
            const handleInputChange = (id, value) => setUserProfile(prev => ({ ...prev, [id]: value }));
            const isProfileComplete = userProfile.name && userProfile.age && QUESTIONS.every(q => userProfile[q.id] && userProfile[q.id].trim() !== "");

            // 3. MATCHMAKING (Sıra Belirleme Eklendi)
            const startMatchmaking = async () => {
                if (!user) return;
                setGameState(GAME_STATES.SEARCHING);
                setSystemMessage(null);

                const queueRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'matchmaking_queue');
                const gamesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'games');

                try {
                    const snapshot = await getDocs(queueRef);
                    const opponentDoc = snapshot.docs.find(doc => doc.data().userId !== user.uid);

                    if (opponentDoc) {
                        // --- EŞLEŞME KURAN KİŞİ ---
                        const opponentData = opponentDoc.data();
                        try {
                            await deleteDoc(opponentDoc.ref);
                            
                            // RASTGELE BAŞLANGIÇ SIRASI
                            const starter = Math.random() < 0.5 ? user.uid : opponentData.userId;

                            const newGameRef = await addDoc(gamesRef, {
                                player1: opponentData,
                                player2: { userId: user.uid, profile: userProfile },
                                status: 'active',
                                currentTurn: starter, // Sıra kimde?
                                createdAt: serverTimestamp(),
                                messages: []
                            });
                            setGameId(newGameRef.id);
                            startGameListener(newGameRef.id);
                        } catch (e) { setTimeout(startMatchmaking, 500); }
                    } else {
                        // --- BEKLEYEN KİŞİ ---
                        const myOldEntries = snapshot.docs.filter(doc => doc.data().userId === user.uid);
                        myOldEntries.forEach(d => deleteDoc(d.ref));

                        const myQueueRef = await addDoc(queueRef, { userId: user.uid, profile: userProfile, createdAt: serverTimestamp() });

                        const unsubGameWait = onSnapshot(gamesRef, (gameSnap) => {
                            const myGame = gameSnap.docs.find(d => {
                                const data = d.data();
                                return data.player1 && data.player1.userId === user.uid && data.status === 'active';
                            });
                            if (myGame) {
                                deleteDoc(myQueueRef).catch(() => {}); 
                                setGameId(myGame.id);
                                unsubGameWait(); 
                                startGameListener(myGame.id);
                            }
                        });
                    }
                } catch (error) {
                    setSystemMessage("Hata: " + error.message);
                    setGameState(GAME_STATES.LOBBY);
                }
            };

            const startGameListener = (id) => {
                if (!user) return;
                const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'games', id);
                
                unsubscribeGameRef.current = onSnapshot(gameRef, (docSnap) => {
                    if (!docSnap.exists()) return;
                    const data = docSnap.data();
                    
                    const isP1 = data.player1.userId === user.uid;
                    const myProf = isP1 ? data.player1.profile : data.player2.profile;
                    const oppProf = isP1 ? data.player2.profile : data.player1.profile;
                    
                    setOpponentProfile(oppProf);
                    setCurrentTurn(data.currentTurn); // Sıra kimde bilgisini al
                    
                    const matchData = calculateMatch(myProf, oppProf);
                    setMatchLevel(matchData.level);
                    setSharedCategories(matchData.shared);
                    
                    if (data.messages) setMessages(data.messages);

                    // BUG FIX: Sadece lobby veya searching modundaysan geçiş yap.
                    setGameState(prevState => {
                        if (prevState === GAME_STATES.SEARCHING || prevState === GAME_STATES.LOBBY) {
                            setTimeout(() => setGameState(GAME_STATES.CHAT), 3000);
                            return GAME_STATES.MATCH_FOUND;
                        }
                        // 3 Mesaj Kuralı: Toplam mesaj 6 olduğunda tahmin ekranına at
                        if (prevState === GAME_STATES.CHAT && data.messages && data.messages.length >= 6) {
                             return GAME_STATES.GUESS_LEVEL;
                        }
                        return prevState;
                    });
                });
            };

            const calculateMatch = (p1Profile, p2Profile) => {
                if(!p1Profile || !p2Profile) return { level: MATCH_LEVELS[0], shared: [], score: 0 };
                let score = 0;
                const shared = [];
                QUESTIONS.forEach(q => {
                    const val1 = p1Profile[q.id]?.toLowerCase().trim();
                    const val2 = p2Profile[q.id]?.toLowerCase().trim();
                    if (val1 && val2 && val1 === val2) {
                        score++;
                        shared.push(q.id);
                    }
                });
                let level = MATCH_LEVELS.find(l => score >= l.minScore && score <= l.maxScore);
                if (!level && score > 4) level = MATCH_LEVELS[4]; 
                return { level, shared, score };
            };

            const sendMessage = async () => {
                if (!inputText.trim() || !gameId) return;
                
                // SIRA KONTROLÜ
                if (currentTurn !== user.uid) {
                    setSystemMessage("Sıra henüz sende değil!");
                    setTimeout(() => setSystemMessage(null), 2000);
                    return;
                }

                // YASAKLI KELİME KONTROLÜ (Gelişmiş)
                const forbiddenWords = Object.values(userProfile).map(v => String(v).toLowerCase());
                const inputLower = inputText.toLowerCase();
                const hasForbidden = forbiddenWords.some(word => word.length > 2 && inputLower.includes(word));

                // DÜZELTİLMİŞ MESAJ GÖNDERME MANTIĞI
                const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'games', gameId);
                
                if (hasForbidden) {
                    setSystemMessage("Yasaklı kelime kullandın! (İsim, yaş veya özellikler)");
                    setInputText("");
                    setTimeout(() => setSystemMessage(null), 3000);
                    return; 
                }
                
                try {
                    // Önce oyun durumunu çekelim ki sıranın kime geçeceğini bulalım
                    const gameSnapDirect = await getDoc(gameRef);
                    if (!gameSnapDirect.exists()) return;
                    
                    const gData = gameSnapDirect.data();
                    // Eğer Player1 isem sıra Player2'ye geçer, değilse Player1'e geçer
                    const nextTurn = gData.player1.userId === user.uid ? gData.player2.userId : gData.player1.userId;
                    
                    // Mevcut mesajların üzerine ekle
                    const currentMessages = gData.messages || [];
                    const newMessage = { senderId: user.uid, text: inputText, timestamp: Date.now() };

                    await updateDoc(gameRef, { 
                        messages: [...currentMessages, newMessage],
                        currentTurn: nextTurn 
                    });
                    
                    setInputText("");
                } catch (e) {
                    console.error("Mesaj gönderme hatası:", e);
                    setSystemMessage("Mesaj gönderilemedi. Lütfen tekrar dene.");
                }
            };

            // --- COMPONENTS ---
            const renderProfileScreen = () => (
                <div className="max-w-4xl mx-auto p-6 pb-20 animate-fade-in">
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600 mb-2">Ruh Eşi Algoritması</h1>
                        <p className="text-gray-400">Profilini doldur, ismini gizlemeden oyna.</p>
                    </div>

                    {/* İSİM VE YAŞ GİRİŞİ */}
                    <div className="bg-gray-800/80 p-6 rounded-xl border border-gray-700 mb-6 flex flex-col md:flex-row gap-4">
                        <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-400 mb-1">İsminiz (Oyunda Görünecek)</label>
                            <input type="text" value={userProfile.name} onChange={(e) => handleInputChange('name', e.target.value)} className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 focus:border-pink-500 focus:ring-1 focus:ring-pink-500 outline-none transition-all" placeholder="Örn: Ahmet" />
                        </div>
                        <div className="w-full md:w-32">
                            <label className="block text-sm font-medium text-gray-400 mb-1">Yaşınız</label>
                            <input type="number" value={userProfile.age} onChange={(e) => handleInputChange('age', e.target.value)} className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 focus:border-pink-500 outline-none transition-all" placeholder="24" />
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {QUESTIONS.map((q) => (
                            <div key={q.id} className="bg-gray-800/50 p-4 rounded-xl border border-gray-700 hover:border-pink-500/50 transition-all group">
                                <label className="flex items-center gap-2 text-gray-200 font-medium mb-3 group-hover:text-pink-400 transition-colors">
                                    <span className="text-pink-500"><Icon name={q.iconName} size={18} /></span>
                                    {q.label}
                                </label>
                                <div className="flex flex-wrap gap-2 mb-3">
                                    {q.options.slice(0, 4).map((opt) => (
                                        <button key={opt} onClick={() => handleInputChange(q.id, opt)} className={`px-2 py-1 text-xs rounded-md transition-all ${userProfile[q.id] === opt ? 'bg-pink-600 text-white shadow-lg shadow-pink-500/25' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                                <input type="text" placeholder="Veya özel cevabın..." value={userProfile[q.id] || ''} onChange={(e) => handleInputChange(q.id, e.target.value)} className="w-full bg-gray-900 border border-gray-700 text-white text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block p-2.5 placeholder-gray-600 transition-colors" />
                            </div>
                        ))}
                    </div>
                    <div className="mt-8 flex justify-center pb-10">
                        <button disabled={!isProfileComplete || !user} onClick={() => setGameState(GAME_STATES.LOBBY)} className={`px-12 py-4 rounded-full font-bold text-lg transition-all transform ${isProfileComplete && user ? 'bg-gradient-to-r from-pink-600 to-violet-600 text-white hover:scale-105 hover:shadow-xl shadow-purple-500/20' : 'bg-gray-800 text-gray-600 cursor-not-allowed border border-gray-700'}`}>
                            {!user ? "Bağlanılıyor..." : isProfileComplete ? "Lobiye Giriş Yap" : "Eksik Alanları Doldur"}
                        </button>
                    </div>
                </div>
            );

            const renderLobbyScreen = () => (
                <div className="flex flex-col items-center justify-center h-[80vh] animate-fade-in relative">
                    <div className="absolute top-4 right-4 bg-gray-800 px-4 py-2 rounded-full flex items-center gap-2 border border-gray-700">
                        <div className={`w-2 h-2 rounded-full ${onlineCount > 0 ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                        <span className="text-gray-300 text-sm font-medium">{onlineCount} Kişi Online</span>
                    </div>
                    {systemMessage && <div className="absolute top-20 bg-red-900/80 text-white px-6 py-3 rounded-lg border border-red-500 shadow-xl z-50 animate-bounce text-center max-w-md"><Icon name="alert-circle" className="inline mr-2"/> {systemMessage}</div>}
                    <h2 className="text-4xl font-black text-white mb-16 tracking-tight">KADER ANI</h2>
                    <div className="relative group cursor-pointer" onClick={startMatchmaking}>
                        <div className="absolute -inset-4 bg-red-500/20 rounded-full blur-xl group-hover:bg-red-500/40 transition-all duration-500 animate-pulse"></div>
                        <div className="relative w-48 h-48 bg-gradient-to-tr from-red-600 to-red-500 rounded-full flex items-center justify-center shadow-[0_0_50px_-10px_rgba(220,38,38,0.5)] transition-transform duration-200 active:scale-95 group-hover:shadow-[0_0_70px_-10px_rgba(220,38,38,0.7)]">
                            <div className="w-40 h-40 rounded-full border-2 border-white/10 flex items-center justify-center">
                                <div className="w-32 h-32 rounded-full bg-gradient-to-b from-red-500 to-red-700 flex items-center justify-center shadow-inner">
                                    <span className="text-white/90 font-bold text-lg tracking-widest">BAŞLAT</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p className="mt-16 text-gray-500 text-center max-w-md text-sm font-medium tracking-wide uppercase">Butona bas ve bekle. Online kimse yoksa, ilk gelen kişiyle eşleşeceksin.</p>
                </div>
            );

            const renderSearchingScreen = () => (
                <div className="flex flex-col items-center justify-center h-[80vh]">
                    <div className="relative w-24 h-24">
                        <div className="absolute inset-0 border-t-4 border-pink-500 rounded-full animate-spin"></div>
                        <div className="absolute inset-2 border-b-4 border-violet-500 rounded-full animate-spin reverse"></div>
                    </div>
                    <h3 className="mt-8 text-2xl font-bold text-white">Eşleşme Aranıyor...</h3>
                    <button onClick={() => { setGameState(GAME_STATES.LOBBY); setSystemMessage(null); }} className="mt-8 px-6 py-2 bg-gray-800 rounded-full text-sm hover:bg-gray-700 border border-gray-700">İptal Et</button>
                </div>
            );

            const renderMatchFoundScreen = () => (
                <div className="flex flex-col items-center justify-center h-[80vh] animate-bounce-in">
                    <div className="bg-gradient-to-br from-green-500 to-emerald-700 p-6 rounded-full mb-6 shadow-2xl shadow-green-500/30">
                        <Icon name="check" size={64} className="text-white" />
                    </div>
                    <h2 className="text-4xl font-bold text-white mb-2">Bağlantı Kuruldu!</h2>
                    <div className="bg-gray-800/80 p-6 rounded-xl border border-gray-700 mt-6 text-center backdrop-blur-sm max-w-md">
                        <div className="flex flex-col items-center gap-2">
                            <Icon name="lock" className="text-pink-500" size={32} />
                            <h3 className="text-2xl font-black text-white mb-2">Seviye Gizlendi</h3>
                            <p className="text-gray-300 text-sm">Sırayla konuşma başladı. Herkesin 3 mesaj hakkı var.</p>
                        </div>
                    </div>
                </div>
            );

            const renderChatScreen = () => {
                const isMyTurn = currentTurn === user.uid;
                const myMessagesCount = messages.filter(m => m.senderId === user.uid).length;
                const remainingRights = 3 - myMessagesCount;

                return (
                    <div className="h-[85vh] flex flex-col max-w-3xl mx-auto">
                        <div className="bg-gray-800 p-4 rounded-t-xl border-b border-gray-700 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg shadow-indigo-500/20">
                                    <Icon name="user" size={20} className="text-white" />
                                </div>
                                <div>
                                    <h3 className="font-bold text-white">{opponentProfile.name || "İsimsiz"} <span className="text-xs font-normal text-gray-400">({opponentProfile.age || "?"})</span></h3>
                                    <span className="text-xs text-gray-400 flex items-center gap-1"><Icon name="lock" size={10} /> Bağ Seviyesi Gizli</span>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded-full border border-gray-700">
                                <Icon name="message-circle" size={14} className={remainingRights === 0 ? "text-red-500" : "text-pink-500"} />
                                <span className="text-sm font-bold text-gray-300">Hak: {remainingRights}/3</span>
                            </div>
                        </div>
                        <div className="flex-1 bg-gray-900/50 overflow-y-auto p-4 space-y-4 scrollbar-thin relative">
                            {systemMessage && (
                                <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-red-600/90 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-xl z-50 animate-bounce">
                                    <Icon name="alert-circle" size={16} className="inline mr-2"/> {systemMessage}
                                </div>
                            )}
                            <div className="text-center my-4">
                                <span className="bg-gray-800 text-gray-400 text-xs px-3 py-1 rounded-full border border-gray-700">Sohbet Başladı - Yasaklı kelimeleri kullanma!</span>
                            </div>
                            {messages.map((msg, idx) => {
                                const isMe = msg.senderId === user.uid;
                                return (
                                    <div key={idx} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] p-3 rounded-2xl ${isMe ? 'bg-pink-600 text-white rounded-tr-none' : 'bg-gray-700 text-gray-200 rounded-tl-none'}`}>
                                            <div className="text-xs opacity-70 mb-1">{isMe ? "Sen" : opponentProfile.name}</div>
                                            {msg.text}
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={chatEndRef} />
                        </div>
                        <div className="p-4 bg-gray-800 rounded-b-xl border-t border-gray-700">
                             {/* SIRA GÖSTERGESİ */}
                            <div className="mb-2 text-center">
                                {isMyTurn ? (
                                    <span className="text-green-400 text-xs font-bold animate-pulse">● Sıra Sende! Mesajını yaz.</span>
                                ) : (
                                    <span className="text-gray-500 text-xs font-bold">○ {opponentProfile.name} yazıyor... Bekle.</span>
                                )}
                            </div>

                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    disabled={!isMyTurn}
                                    value={inputText} 
                                    onChange={(e) => setInputText(e.target.value)} 
                                    onKeyDown={(e) => e.key === 'Enter' && sendMessage()} 
                                    placeholder={isMyTurn ? "Mesajını yaz..." : "Sıranı bekle..."}
                                    className={`flex-1 bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none transition-colors placeholder-gray-600 ${!isMyTurn && 'opacity-50 cursor-not-allowed'}`} 
                                />
                                <button 
                                    disabled={!isMyTurn}
                                    onClick={sendMessage} 
                                    className={`bg-pink-600 text-white px-4 rounded-lg transition-colors flex items-center justify-center shadow-lg shadow-pink-600/20 ${!isMyTurn ? 'opacity-50 cursor-not-allowed' : 'hover:bg-pink-700'}`}
                                >
                                    <Icon name="send" size={20} />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderGuessLevelScreen = () => (
                <div className="max-w-2xl mx-auto p-6 text-center h-[80vh] flex flex-col justify-center">
                    <h2 className="text-3xl font-bold text-white mb-6">Süre Doldu!</h2>
                    <p className="text-gray-400 mb-10 text-lg">Konuşmalarınıza dayanarak, {opponentProfile.name} ile aranızdaki uyum nedir?</p>
                    <div className="space-y-3 max-w-md mx-auto w-full">
                        {MATCH_LEVELS.map((level) => (
                            <button key={level.id} onClick={() => { setGuessedLevel(level); setGameState(GAME_STATES.GUESS_CRITERIA); }} className="w-full bg-gray-800/80 hover:bg-gray-700 border border-gray-700 hover:border-pink-500 p-4 rounded-xl transition-all flex items-center justify-between group backdrop-blur-sm">
                                <span className={`text-lg font-bold ${level.color}`}>{level.label}</span>
                                <span className="text-gray-500 text-sm opacity-0 group-hover:opacity-100 transition-opacity">Seç &rarr;</span>
                            </button>
                        ))}
                    </div>
                </div>
            );

            const renderGuessCriteriaScreen = () => (
                <div className="max-w-4xl mx-auto p-6 pb-20">
                    <h2 className="text-3xl font-bold text-center text-white mb-2">Neden "{guessedLevel?.label}"?</h2>
                    <p className="text-center text-gray-400 mb-8">Hangi konularda ortak olduğunuzu düşünüyorsun?</p>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-8">
                        {QUESTIONS.map((q) => (
                            <button key={q.id} onClick={() => setGuesses(prev => ({ ...prev, [q.id]: !prev[q.id] }))} className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all ${guesses[q.id] ? 'bg-pink-500/20 border-pink-500 text-pink-400' : 'bg-gray-800 border-gray-700 text-gray-500 hover:border-gray-600'}`}>
                                <Icon name={q.iconName} size={18} />
                                <span className="text-xs font-medium text-center">{q.label.split('?')[0]}</span>
                            </button>
                        ))}
                    </div>
                    <div className="flex justify-center">
                        <button onClick={() => setGameState(GAME_STATES.RESULT)} className="bg-gradient-to-r from-pink-600 to-violet-600 px-12 py-4 rounded-full text-white font-bold text-xl shadow-lg shadow-pink-500/25 hover:scale-105 transition-transform">Gerçeği Gör</button>
                    </div>
                </div>
            );

            const renderResultScreen = () => {
                if (!matchLevel) return <div>Veriler yükleniyor...</div>;
                const correctGuesses = Object.keys(guesses).filter(id => guesses[id] && sharedCategories.includes(id)).length;
                const totalShared = sharedCategories.length;
                const successRate = totalShared > 0 ? Math.round((correctGuesses / totalShared) * 100) : (Object.keys(guesses).length === 0 ? 100 : 0);
                const levelGuessCorrect = guessedLevel?.id === matchLevel?.id;

                return (
                    <div className="max-w-4xl mx-auto p-6 pb-20">
                        <div className="text-center mb-8">
                            <h2 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600 mb-2">YÜZLEŞME</h2>
                            
                            {/* BAŞARI KARNESİ */}
                            <div className="bg-gray-800 inline-flex items-center gap-4 px-6 py-3 rounded-full border border-gray-700 shadow-xl mt-4">
                                <div className="text-right">
                                    <div className="text-xs text-gray-400 uppercase tracking-wider">Dedektiflik Puanın</div>
                                    <div className="text-2xl font-bold text-white">% {successRate}</div>
                                </div>
                                <div className={`w-12 h-12 rounded-full flex items-center justify-center border-4 ${successRate > 70 ? 'border-green-500 text-green-500' : successRate > 40 ? 'border-yellow-500 text-yellow-500' : 'border-red-500 text-red-500'}`}>
                                    <Icon name={successRate > 70 ? "trophy" : "target"} size={20} />
                                </div>
                            </div>
                        </div>

                        <div className="flex flex-col md:flex-row justify-center gap-6 mt-8 items-center mb-10">
                            <div className="bg-gray-800 p-6 rounded-2xl border border-gray-700 min-w-[200px] text-center">
                                <p className="text-gray-500 text-xs uppercase tracking-wider mb-1">Hissiyatın</p>
                                <p className={`text-xl font-bold ${guessedLevel?.color}`}>{guessedLevel?.label}</p>
                            </div>
                            {levelGuessCorrect ? (
                                <div className="bg-green-500 text-white p-3 rounded-full shadow-lg animate-bounce"><Icon name="check" size={24} /></div>
                            ) : (
                                <div className="text-gray-700 font-mono">VS</div>
                            )}
                            <div className="bg-gray-800 p-6 rounded-2xl border border-gray-700 min-w-[200px] text-center relative overflow-hidden">
                                <div className="absolute top-0 right-0 bg-pink-600 text-white text-[10px] px-2 py-1 rounded-bl">GERÇEK</div>
                                <p className="text-gray-500 text-xs uppercase tracking-wider mb-1">Algoritma</p>
                                <p className={`text-xl font-bold ${matchLevel.color}`}>{matchLevel.label}</p>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="bg-gray-800/50 rounded-2xl p-6 border border-gray-700">
                                <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Icon name="user" size={18}/> {userProfile.name}</h3>
                                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 scrollbar-thin">
                                    {QUESTIONS.map(q => (
                                        <div key={q.id} className={`flex justify-between text-sm p-2 rounded-lg ${sharedCategories.includes(q.id) ? 'bg-green-500/10 border border-green-500/20' : 'bg-gray-900/30'}`}>
                                            <span className={sharedCategories.includes(q.id) ? 'text-green-400' : 'text-gray-500'}>{q.label.split('?')[0]}</span>
                                            <span className="font-medium text-white">{userProfile[q.id]}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-gray-800/50 rounded-2xl p-6 border border-gray-700 relative">
                                <div className="absolute -top-3 -right-3 bg-violet-600 text-white text-xs px-3 py-1 rounded-full shadow-lg">Partner</div>
                                <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Icon name="ghost" size={18}/> {opponentProfile.name}</h3>
                                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 scrollbar-thin">
                                    {QUESTIONS.map(q => (
                                        <div key={q.id} className={`flex justify-between text-sm p-2 rounded-lg ${sharedCategories.includes(q.id) ? 'bg-green-500/10 border border-green-500/20' : 'bg-gray-900/30'}`}>
                                            <span className={sharedCategories.includes(q.id) ? 'text-green-400' : 'text-gray-500'}>{opponentProfile[q.id]}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="mt-8 flex justify-center">
                            <button onClick={() => { setGameState(GAME_STATES.LOBBY); setGameId(null); setMessages([]); setQuestionsLeft(3); setCurrentTurn(null); }} className="text-gray-400 hover:text-white font-medium underline decoration-pink-500 underline-offset-4 transition-colors">Yeni Bir Şans Dene</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="relative z-10 container mx-auto px-4 py-4">
                    {gameState === GAME_STATES.PROFILE && renderProfileScreen()}
                    {gameState === GAME_STATES.LOBBY && renderLobbyScreen()}
                    {gameState === GAME_STATES.SEARCHING && renderSearchingScreen()}
                    {gameState === GAME_STATES.MATCH_FOUND && renderMatchFoundScreen()}
                    {gameState === GAME_STATES.CHAT && renderChatScreen()}
                    {gameState === GAME_STATES.GUESS_LEVEL && renderGuessLevelScreen()}
                    {gameState === GAME_STATES.GUESS_CRITERIA && renderGuessCriteriaScreen()}
                    {gameState === GAME_STATES.RESULT && renderResultScreen()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MysteryConnectionGame />);
    </script>
</body>
</html>


