<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gizemli BaÄŸ - Ruh EÅŸi AlgoritmasÄ±</title>
    
    <!-- Stil KÃ¼tÃ¼phanesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React (Oyun Motoru) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (Kod Derleyici) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- FIREBASE (Global Compat SÃ¼rÃ¼mÃ¼ - Siyah Ekran Ã‡Ã¶zÃ¼mÃ¼) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        @keyframes bounce-in { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        .animate-bounce-in { animation: bounce-in 0.6s cubic-bezier(0.215, 0.610, 0.355, 1.000); }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #db2777; border-radius: 20px; }
        
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #374151; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #db2777; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #4b5563; border-radius: 2px; }
    </style>
</head>
<body class="bg-[#09090b] text-white font-sans selection:bg-pink-500 selection:text-white overflow-x-hidden">

    <div id="root"></div>

    <script type="text/babel">
        // ==================================================================
        // FIREBASE AYARLARI
        // ==================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyC67niOAv8lLVAlDDRVSCQFTdyJO2eMn94",
            authDomain: "lier-db123.firebaseapp.com",
            projectId: "lier-db123",
            storageBucket: "lier-db123.firebasestorage.app",
            messagingSenderId: "637814349438",
            appId: "1:637814349438:web:c670c3e13dd5bd28a6422f",
            measurementId: "G-FLFVH8Z4R9"
        };

        // Global Firebase BaÅŸlatma (Siyah EkranÄ± Ã–nleyen YÃ¶ntem)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const APP_ID = "mystery-connection-final"; // Temiz veritabanÄ± iÃ§in yeni ID

        // ==================================================================
        // ğŸµ MÃœZÄ°K DOSYASI ğŸµ
        // ==================================================================
        const BACKGROUND_MUSIC_URL = "Inner Stillness.mp3"; 
        // ==================================================================


        // --- GARANTÄ° SVG Ä°KONLAR ---
        const ICONS = {
            'mail': <g><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></g>,
            'settings': <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
            'edit': <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
            'logout': <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></g>,
            'trash': <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
            'user': <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
            'lock': <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></g>,
            'message': <g><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></g>,
            'send': <g><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></g>,
            'check': <g><polyline points="20 6 9 17 4 12"/></g>,
            'trophy': <g><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17"/><path d="M14 14.66V17"/><path d="M18 22l-.5-10"/><path d="M6 22l.5-10"/><path d="M9 22a2 2 0 0 1-2-2 4 4 0 0 1 4-4h2a4 4 0 0 1 4 4 2 2 0 0 1-2 2"/></g>,
            'arrow-left': <g><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></g>,
            'music': <g><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></g>,
            'x': <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
            'zap': <g><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></g>,
            'heart': <g><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></g>,
            'ghost': <g><path d="M9 22l1.5-1.5L12 22l1.5-1.5L15 22l1.5-1.5L18 22V7a6 6 0 0 0-6-6 6 6 0 0 0-6 6v15z"/></g>,
            'play': <polygon points="5 3 19 12 5 21 5 3"></polygon>,
            'pause': <g><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></g>
        };

        const Icon = ({ name, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {ICONS[name] || null}
            </svg>
        );

        // --- SABÄ°TLER ---
        const GAME_STATES = { AUTH: 'AUTH', PROFILE: 'PROFILE', LOBBY: 'LOBBY', SEARCHING: 'SEARCHING', MATCH_FOUND: 'MATCH_FOUND', CHAT: 'CHAT', GUESS_LEVEL: 'GUESS_LEVEL', GUESS_CRITERIA: 'GUESS_CRITERIA', RESULT: 'RESULT', INBOX: 'INBOX' };
        const MATCH_LEVELS = [{id:0,label:"FarklÄ± DÃ¼nyalar",color:"text-gray-500",limit:0},{id:1,label:"TesadÃ¼fi Benzerlik",color:"text-blue-400",limit:1},{id:2,label:"Ortak Frekans",color:"text-green-400",limit:2},{id:3,label:"GÃ¼Ã§lÃ¼ BaÄŸ",color:"text-purple-400",limit:3},{id:4,label:"Ruh EÅŸi",color:"text-pink-500",limit:99}];
        const QUESTIONS = [
            { id: 'color', label: 'Renk', iconName: 'zap', options: ['Mavi','KÄ±rmÄ±zÄ±','Siyah','YeÅŸil','SarÄ±','Mor','Turuncu','Beyaz'] },
            { id: 'food', label: 'Yemek', iconName: 'heart', options: ['Pizza','Burger','Sushi','Kebap','Makarna','Salata','TatlÄ±','MantÄ±'] },
            { id: 'toy', label: 'Oyuncak', iconName: 'ghost', options: ['Lego','Bebek','Araba','PeluÅŸ','Action Man','Top','Gameboy','Puzzle'] },
            { id: 'music', label: 'MÃ¼zik', iconName: 'music', options: ['Pop','Rock','Rap','Klasik','Jazz','Elektronik','Indie','Metal'] },
            { id: 'person', label: 'Ä°nsan', iconName: 'user', options: ['Aile','Dost','Sevgili','Kendim','Mentor','Evcil Hayvan'] },
            { id: 'fear', label: 'Korku', iconName: 'ghost', options: ['YalnÄ±zlÄ±k','YÃ¼kseklik','BÃ¶cek','BaÅŸarÄ±sÄ±zlÄ±k','KaranlÄ±k','Ã–lÃ¼m','PalyaÃ§o'] },
            { id: 'excitement', label: 'Heyecan', iconName: 'zap', options: ['Seyahat','Para','AÅŸk','Yemek','Adrenalin','Ã–ÄŸrenmek'] },
            { id: 'talent', label: 'Yetenek', iconName: 'star', options: ['UÃ§mak','GÃ¶rÃ¼nmezlik','Zihin Okuma','ZamanÄ± Durdurma','IÅŸÄ±nlanma'] }
        ];

        function MysteryConnectionGame() {
            const { useState, useEffect, useRef } = React;
            const [user, setUser] = useState(null);
            const [gameState, setGameState] = useState(GAME_STATES.AUTH);
            const [userProfile, setUserProfile] = useState({ name: '', age: '' });
            const [opponentProfile, setOpponentProfile] = useState({});
            const [matchLevel, setMatchLevel] = useState(null);
            const [sharedCategories, setSharedCategories] = useState([]);
            const [authMode, setAuthMode] = useState('LOGIN');
            const [authCreds, setAuthCreds] = useState({ username: '', password: '' });
            const [authLoading, setAuthLoading] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [volume, setVolume] = useState(0.5);
            const [isPlaying, setIsPlaying] = useState(false); // MÃ¼zik durumunu takip et
            const [gameId, setGameId] = useState(null);
            const [currentTurn, setCurrentTurn] = useState(null);
            const [onlineCount, setOnlineCount] = useState(0);
            const unsubscribeGameRef = useRef(null);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState("");
            const [systemMessage, setSystemMessage] = useState(null);
            const [guessedLevel, setGuessedLevel] = useState(null);
            const [guesses, setGuesses] = useState({});
            const [score, setScore] = useState(0);
            const [inboxGames, setInboxGames] = useState([]);
            const [isUnlimitedChat, setIsUnlimitedChat] = useState(false);
            const chatEndRef = useRef(null);
            const audioRef = useRef(null);

            // --- MÃœZÄ°K SÄ°STEMÄ° (DÃœZELTÄ°LDÄ°) ---
            useEffect(() => {
                audioRef.current = new Audio(BACKGROUND_MUSIC_URL);
                audioRef.current.loop = true;
                audioRef.current.volume = volume;
                
                // Ä°lk tÄ±klamada Ã§almayÄ± dene
                const tryPlay = () => {
                    if(audioRef.current.paused) {
                        audioRef.current.play().then(() => setIsPlaying(true)).catch(() => {});
                    }
                };
                document.addEventListener('click', tryPlay, { once: true });
                
                return () => {
                    document.removeEventListener('click', tryPlay);
                    if(audioRef.current) {
                        audioRef.current.pause();
                        audioRef.current = null;
                    }
                };
            }, []);

            // Ses seviyesi deÄŸiÅŸtiÄŸinde
            useEffect(() => {
                if(audioRef.current) audioRef.current.volume = volume;
            }, [volume]);

            const toggleMusic = () => {
                if(!audioRef.current) return;
                if(isPlaying) {
                    audioRef.current.pause();
                    setIsPlaying(false);
                } else {
                    audioRef.current.play().then(() => setIsPlaying(true)).catch(e => console.log("Play failed", e));
                }
            };

            // --- AUTH ---
            useEffect(() => {
                auth.onAuthStateChanged(async (u) => { 
                    if (u) {
                        setUser(u);
                        const docRef = db.collection('artifacts').doc(APP_ID).collection('users').doc(u.uid).collection('data').doc('profile');
                        const docSnap = await docRef.get();
                        if (docSnap.exists) { setUserProfile(docSnap.data()); setGameState(GAME_STATES.LOBBY); } else { setGameState(GAME_STATES.PROFILE); }
                    } else { setUser(null); setGameState(GAME_STATES.AUTH); }
                });
            }, []);

            useEffect(() => {
                if (!user) return;
                const presenceRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('presence').doc(user.uid);
                const updatePresence = () => presenceRef.set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid }, { merge: true }).catch(()=>{});
                updatePresence();
                const interval = setInterval(updatePresence, 30000);
                const unsub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('presence').onSnapshot((snap) => {
                    const now = new Date();
                    setOnlineCount(snap.docs.filter(d => { const dt = d.data(); return dt.lastSeen && (now - dt.lastSeen.toDate()) < 120000; }).length);
                });
                return () => { clearInterval(interval); unsub(); };
            }, [user]);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            useEffect(() => {
                if (!user || gameState === GAME_STATES.AUTH) return;
                const unsub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('games').onSnapshot((snap) => {
                    const myGames = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                        .filter(g => (g.player1.userId === user.uid || g.player2.userId === user.uid) && g.status === 'shared')
                        .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setInboxGames(myGames);
                });
                return () => unsub();
            }, [user, gameState]);

            // --- FONKSÄ°YONLAR ---
            const handleAuth = async () => {
                if (!authCreds.username || !authCreds.password) return setSystemMessage("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.");
                setAuthLoading(true); setSystemMessage(null);
                const email = `${authCreds.username.toLowerCase()}@gizemlibag.com`;
                try {
                    if (authMode === 'REGISTER') {
                        const uRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('usernames').doc(authCreds.username.toLowerCase());
                        const s = await uRef.get();
                        if (s.exists) throw new Error("USERNAME_TAKEN");
                        const uc = await auth.createUserWithEmailAndPassword(email, authCreds.password);
                        await uRef.set({ uid: uc.user.uid });
                        await db.collection('artifacts').doc(APP_ID).collection('users').doc(uc.user.uid).collection('data').doc('profile').set({ username: authCreds.username, name: authCreds.username, age: '' });
                    } else { await auth.signInWithEmailAndPassword(email, authCreds.password); }
                } catch (e) {
                    let msg = "Hata oluÅŸtu.";
                    if (e.message === "USERNAME_TAKEN") msg = "KullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ.";
                    else if (e.code === 'auth/operation-not-allowed') msg = "Firebase Email/Pass giriÅŸi kapalÄ±!";
                    else if (e.code?.includes('invalid-credential')) msg = "HatalÄ± giriÅŸ.";
                    setSystemMessage(msg);
                } finally { setAuthLoading(false); }
            };

            const handleLogout = async () => { await auth.signOut(); setGameState(GAME_STATES.AUTH); setShowSettings(false); };
            const handleDeleteAccount = async () => {
                try {
                    await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('data').doc('profile').delete();
                    if (userProfile.username) await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('usernames').doc(userProfile.username.toLowerCase()).delete();
                    await user.delete(); setGameState(GAME_STATES.AUTH); setShowSettings(false); setShowDeleteConfirm(false);
                } catch (e) { setSystemMessage("Hesap silme hatasÄ±."); }
            };
            const saveProfile = async () => { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('data').doc('profile').set(userProfile, { merge: true }); setGameState(GAME_STATES.LOBBY); setShowSettings(false); };
            const isProfileComplete = userProfile.name && userProfile.age && QUESTIONS.every(q => userProfile[q.id] && userProfile[q.id].trim() !== "");

            const startMatchmaking = async () => {
                if (!user) return;
                setMessages([]); setGameId(null); setCurrentTurn(null); setOpponentProfile({}); setGuesses({}); setGuessedLevel(null); setScore(0); setIsUnlimitedChat(false);
                setGameState(GAME_STATES.SEARCHING); setSystemMessage(null);
                const myToken = Math.random().toString(36).substring(2) + Date.now().toString(36);
                const qRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('matchmaking_queue');
                const gRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('games');
                try {
                    const snap = await qRef.get();
                    const now = Date.now();
                    snap.docs.forEach(d => { const dt = d.data(); const ct = dt.createdAt?.toDate ? dt.createdAt.toDate().getTime() : 0; if (ct > 0 && (now - ct > 120000)) d.ref.delete().catch(()=>{}); });
                    const oppDoc = snap.docs.find(d => { const dt = d.data(); if (dt.userId === user.uid) return false; const ct = dt.createdAt?.toDate ? dt.createdAt.toDate().getTime() : now; return (now - ct) < 45000; });
                    if (oppDoc) {
                        const oppData = oppDoc.data();
                        try {
                            await oppDoc.ref.delete();
                            const starter = Math.random() < 0.5 ? user.uid : oppData.userId;
                            const newGame = await gRef.add({ player1: oppData, player2: { userId: user.uid, profile: userProfile }, status: 'active', matchToken: oppData.matchToken, currentTurn: starter, createdAt: firebase.firestore.FieldValue.serverTimestamp(), messages: [] });
                            setGameId(newGame.id); startGameListener(newGame.id);
                        } catch (e) { setTimeout(startMatchmaking, 500); }
                    } else {
                        snap.docs.filter(d => d.data().userId === user.uid).forEach(d => d.ref.delete());
                        const myQ = await qRef.add({ userId: user.uid, profile: userProfile, createdAt: firebase.firestore.FieldValue.serverTimestamp(), matchToken: myToken });
                        const unsub = gRef.onSnapshot((gs) => {
                            const mg = gs.docs.find(d => d.data().matchToken === myToken && d.data().status === 'active');
                            if (mg) { myQ.delete().catch(()=>{}); setGameId(mg.id); unsub(); startGameListener(mg.id); }
                        });
                    }
                } catch (e) { setSystemMessage("Hata: " + e.message); setGameState(GAME_STATES.LOBBY); }
            };

            const startGameListener = (id) => {
                const gRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('games').doc(id);
                unsubscribeGameRef.current = gRef.onSnapshot((snap) => {
                    if (!snap.exists) return;
                    const d = snap.data();
                    const isP1 = d.player1.userId === user.uid;
                    const opp = isP1 ? d.player2.profile : d.player1.profile;
                    setOpponentProfile(opp); setCurrentTurn(d.currentTurn);
                    let sc = 0; const sh = [];
                    QUESTIONS.forEach(q => { if (userProfile[q.id]?.toLowerCase().trim() === opp[q.id]?.toLowerCase().trim()) { sc++; sh.push(q.id); } });
                    let lvl = MATCH_LEVELS[0];
                    if (sc === 1) lvl = MATCH_LEVELS[1]; else if (sc === 2) lvl = MATCH_LEVELS[2]; else if (sc === 3) lvl = MATCH_LEVELS[3]; else if (sc >= 4) lvl = MATCH_LEVELS[4];
                    setMatchLevel(lvl); setSharedCategories(sh);
                    
                    if (d.messages) setMessages(d.messages);
                    if (d.status === 'shared') setIsUnlimitedChat(true);

                    setGameState(prev => {
                        if (prev === GAME_STATES.SEARCHING || prev === GAME_STATES.LOBBY) { setTimeout(() => setGameState(GAME_STATES.CHAT), 2000); return GAME_STATES.MATCH_FOUND; }
                        if (!isUnlimitedChat && d.status === 'active' && prev === GAME_STATES.CHAT && d.messages && d.messages.length >= 6) return GAME_STATES.GUESS_LEVEL;
                        return prev;
                    });
                });
            };

            const sendMessage = async () => {
                if (!inputText.trim() || !gameId) return;
                if (!isUnlimitedChat && currentTurn !== user.uid) { setSystemMessage("SÄ±ra sende deÄŸil!"); setTimeout(() => setSystemMessage(null), 2000); return; }
                const forbids = Object.values(userProfile).map(v => String(v).toLowerCase());
                if (!isUnlimitedChat && forbids.some(w => w.length > 2 && inputText.toLowerCase().includes(w))) { setSystemMessage("YasaklÄ± kelime!"); setInputText(""); setTimeout(() => setSystemMessage(null), 2000); return; }
                const gRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('games').doc(gameId);
                try {
                    const gs = await gRef.get(); const gd = gs.data();
                    const next = gd.player1.userId === user.uid ? gd.player2.userId : gd.player1.userId;
                    await gRef.update({ messages: [...(gd.messages || []), { senderId: user.uid, text: inputText, timestamp: Date.now(), type: 'text' }], currentTurn: next });
                    setInputText("");
                } catch (e) {}
            };

            const handleGuessToggle = (id) => {
                const lim = guessedLevel?.limit || 0;
                const cnt = Object.values(guesses).filter(Boolean).length;
                if (!guesses[id] && cnt >= lim && lim !== 99) { setSystemMessage(`Maksimum ${lim} seÃ§im!`); setTimeout(() => setSystemMessage(null), 2000); return; }
                setGuesses(p => ({ ...p, [id]: !p[id] }));
            };

            const finalizeScore = () => {
                let fs = guessedLevel.id === matchLevel.id ? 40 : 0;
                const ts = sharedCategories.length;
                if (ts > 0) {
                    let c = 0, w = 0;
                    Object.keys(guesses).forEach(k => { if (guesses[k]) { if (sharedCategories.includes(k)) c++; else w++; } });
                    fs += (c * (60/ts)) - (w * (60/ts));
                } else if (Object.values(guesses).filter(Boolean).length === 0) fs += 60;
                setScore(Math.max(0, Math.min(100, Math.round(fs))));
                setGameState(GAME_STATES.RESULT);
            };

            const shareResults = async () => {
                if (!gameId) return;
                const gRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('games').doc(gameId);
                const gs = await gRef.get();
                await gRef.update({ status: 'shared', messages: [...(gs.data().messages||[]), { senderId: user.uid, type: 'result_card', timestamp: Date.now(), data: { score, guessedLevel: guessedLevel.label } }] });
                setSystemMessage("GÃ¶nderildi!"); setTimeout(() => { setSystemMessage(null); setGameState(GAME_STATES.LOBBY); }, 2000);
            };

            const openInboxGame = (game) => {
                setGameId(game.id);
                setIsUnlimitedChat(true);
                startGameListener(game.id);
                setGameState(GAME_STATES.CHAT);
            };

            // --- UI RENDER ---
            const renderSettingsModal = () => (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in" onClick={(e) => e.target === e.currentTarget && setShowSettings(false)}>
                    <div className="bg-gray-800 border border-gray-700 p-6 rounded-2xl w-80 shadow-2xl relative">
                        <button onClick={() => setShowSettings(false)} className="absolute top-4 right-4 text-gray-400 hover:text-white"><Icon name="x" /></button>
                        <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><Icon name="settings" className="text-pink-500"/> Ayarlar</h2>
                        <div className="space-y-4">
                            <button onClick={() => { setShowSettings(false); setGameState(GAME_STATES.PROFILE); }} className="w-full flex items-center gap-3 bg-gray-700 hover:bg-gray-600 p-3 rounded-xl transition-colors text-left"><Icon name="edit" size={20} className="text-blue-400" /> Ã–zelliklerimi DeÄŸiÅŸtir</button>
                            
                            <div className="bg-gray-700 p-3 rounded-xl">
                                <div className="flex justify-between mb-2 text-sm text-gray-300">
                                    <span className="flex items-center gap-2"><Icon name="music" size={16}/> MÃ¼zik Sesi</span>
                                    <button onClick={toggleMusic} className="text-pink-400 hover:text-pink-300">
                                        {isPlaying ? <Icon name="pause" size={16}/> : <Icon name="play" size={16}/>}
                                    </button>
                                </div>
                                <input type="range" min="0" max="1" step="0.1" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-pink-500" />
                            </div>

                            <button onClick={handleLogout} className="w-full flex items-center gap-3 bg-gray-700 hover:bg-gray-600 p-3 rounded-xl transition-colors text-left text-yellow-500"><Icon name="logout" size={20} /> Ã‡Ä±kÄ±ÅŸ Yap</button>
                            <button onClick={() => setShowDeleteConfirm(true)} className="w-full flex items-center gap-3 bg-red-900/30 hover:bg-red-900/50 border border-red-900 p-3 rounded-xl transition-colors text-left text-red-400"><Icon name="trash" size={20} /> HesabÄ±mÄ± Sil</button>
                        </div>
                    </div>
                    {showDeleteConfirm && (<div className="absolute inset-0 flex items-center justify-center bg-black/90 rounded-2xl"><div className="text-center p-6"><h3 className="text-red-500 font-bold text-lg mb-2">Emin misin?</h3><div className="flex gap-2 justify-center"><button onClick={() => setShowDeleteConfirm(false)} className="bg-gray-700 px-4 py-2 rounded-lg">Ä°ptal</button><button onClick={handleDeleteAccount} className="bg-red-600 px-4 py-2 rounded-lg text-white font-bold">Sil</button></div></div></div>)}
                </div>
            );

            if (gameState === GAME_STATES.AUTH) return (
                <div className="flex flex-col items-center justify-center h-[90vh] p-6 animate-fade-in">
                    <div className="w-full max-w-md bg-gray-800/90 p-8 rounded-2xl border border-gray-700 shadow-2xl">
                        <div className="text-center mb-8"><h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 mb-2">GÄ°ZEMLÄ° BAÄ</h1><p className="text-gray-400 text-sm">Kaderindeki kiÅŸiyi bulmaya hazÄ±r mÄ±sÄ±n?</p></div>
                        {systemMessage && <div className="bg-red-900/50 border border-red-500 text-red-200 text-sm p-3 rounded-lg mb-4 flex items-center gap-2"><Icon name="alert-circle" size={16} /> {systemMessage}</div>}
                        <div className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">KullanÄ±cÄ± AdÄ±</label><input type="text" value={authCreds.username} onChange={(e) => setAuthCreds(p => ({...p, username: e.target.value.replace(/\s/g, '')}))} className="w-full bg-gray-900 border border-gray-600 rounded-xl p-4 text-white focus:border-pink-500 outline-none" placeholder="kullaniciadi" /></div>
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Åifre</label><input type="password" value={authCreds.password} onChange={(e) => setAuthCreds(p => ({...p, password: e.target.value}))} className="w-full bg-gray-900 border border-gray-600 rounded-xl p-4 text-white focus:border-pink-500 outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" /></div>
                            <button onClick={handleAuth} disabled={authLoading} className="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-4 rounded-xl shadow-lg hover:scale-[1.02] transition-all disabled:opacity-50">{authLoading ? "Ä°ÅŸleniyor..." : (authMode === 'LOGIN' ? "GiriÅŸ Yap" : "KayÄ±t Ol")}</button>
                        </div>
                        <div className="mt-6 text-center"><button onClick={() => { setAuthMode(authMode === 'LOGIN' ? 'REGISTER' : 'LOGIN'); setSystemMessage(null); }} className="text-gray-400 hover:text-white text-sm underline decoration-pink-500 underline-offset-4">{authMode === 'LOGIN' ? "HesabÄ±n yok mu? KayÄ±t Ol" : "Zaten hesabÄ±n var mÄ±? GiriÅŸ Yap"}</button></div>
                    </div>
                </div>
            );

            if (gameState === GAME_STATES.PROFILE) return (
                <div className="max-w-4xl mx-auto p-6 pb-20 animate-fade-in">
                    <div className="text-center mb-8"><h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600 mb-2">Profil OluÅŸtur</h1></div>
                    <div className="bg-gray-800/80 p-6 rounded-xl border border-gray-700 mb-6 flex flex-col md:flex-row gap-4"><div className="flex-1"><label className="text-gray-400 text-sm">Ä°sim</label><input type="text" value={userProfile.name} onChange={(e) => setUserProfile(p => ({...p, name: e.target.value}))} className="w-full bg-gray-900 border border-gray-700 rounded p-2 outline-none" /></div><div className="w-32"><label className="text-gray-400 text-sm">YaÅŸ</label><input type="number" value={userProfile.age} onChange={(e) => setUserProfile(p => ({...p, age: e.target.value}))} className="w-full bg-gray-900 border border-gray-700 rounded p-2 outline-none" /></div></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{QUESTIONS.map((q) => (<div key={q.id} className="bg-gray-800/50 p-4 rounded-xl border border-gray-700"><label className="flex items-center gap-2 text-pink-500 mb-2"><Icon name={q.iconName} size={18} /> {q.label}</label><div className="flex flex-wrap gap-2 mb-2">{q.options.slice(0,4).map(opt => (<button key={opt} onClick={() => setUserProfile(p => ({...p, [q.id]: opt}))} className={`px-2 py-1 text-xs rounded ${userProfile[q.id] === opt ? 'bg-pink-600 text-white' : 'bg-gray-700 text-gray-300'}`}>{opt}</button>))}</div><input type="text" placeholder="Ã–zel cevap..." value={userProfile[q.id] || ''} onChange={(e) => setUserProfile(p => ({...p, [q.id]: e.target.value}))} className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm outline-none" /></div>))}</div>
                    <div className="mt-8 flex justify-center pb-10"><button disabled={!isProfileComplete} onClick={saveProfile} className="px-12 py-4 bg-pink-600 rounded-full font-bold text-white hover:scale-105 transition-transform disabled:opacity-50">Kaydet ve Devam Et</button></div>
                </div>
            );

            if (gameState === GAME_STATES.LOBBY) return (
                <div className="flex flex-col items-center justify-center h-[80vh] animate-fade-in relative">
                    {showSettings && renderSettingsModal()}
                    <div className="absolute top-0 left-0 w-full p-4 flex justify-between items-center">
                        <button onClick={() => setGameState(GAME_STATES.INBOX)} className="relative bg-gray-800 p-3 rounded-full hover:bg-gray-700 border border-gray-600 flex items-center justify-center w-12 h-12"><Icon name="mail" size={24} className="text-white" />{inboxGames.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-xs w-5 h-5 flex items-center justify-center rounded-full">{inboxGames.length}</span>}</button>
                        <div className="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-full border border-gray-700"><div className={`w-2 h-2 rounded-full ${onlineCount > 0 ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div><span className="text-gray-300 text-sm">{onlineCount} Online</span></div>
                        <button onClick={() => setShowSettings(true)} className="bg-gray-800 p-3 rounded-full hover:bg-gray-700 border border-gray-600 flex items-center justify-center w-12 h-12"><Icon name="settings" size={24} className="text-white" /></button>
                    </div>
                    {systemMessage && <div className="absolute top-20 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl z-50 animate-bounce">{systemMessage}</div>}
                    <h2 className="text-5xl font-black text-white mb-16 tracking-tight drop-shadow-lg">KADER ANI</h2>
                    <div className="relative group cursor-pointer" onClick={startMatchmaking}><div className="absolute -inset-4 bg-red-500/20 rounded-full blur-xl group-hover:bg-red-500/40 transition-all duration-500 animate-pulse"></div><div className="relative w-48 h-48 bg-gradient-to-tr from-red-600 to-red-500 rounded-full flex items-center justify-center shadow-[0_0_50px_-10px_rgba(220,38,38,0.5)] transition-transform duration-200 active:scale-95 group-hover:shadow-[0_0_70px_-10px_rgba(220,38,38,0.7)]"><div className="w-40 h-40 rounded-full border-2 border-white/10 flex items-center justify-center"><div className="w-32 h-32 rounded-full bg-gradient-to-b from-red-500 to-red-700 flex items-center justify-center shadow-inner"><span className="text-white/90 font-bold text-lg tracking-widest">BAÅLAT</span></div></div></div></div>
                    <p className="mt-16 text-gray-500 text-center max-w-md text-sm font-medium uppercase">Butona bas, anlÄ±k olarak online olan birini bul.</p>
                </div>
            );

            if (gameState === GAME_STATES.SEARCHING) return (<div className="flex flex-col items-center justify-center h-[80vh]"><div className="relative w-24 h-24"><div className="absolute inset-0 border-t-4 border-pink-500 rounded-full animate-spin"></div><div className="absolute inset-2 border-b-4 border-violet-500 rounded-full animate-spin reverse"></div></div><h3 className="mt-8 text-2xl font-bold text-white">EÅŸleÅŸme AranÄ±yor...</h3><button onClick={() => { setGameState(GAME_STATES.LOBBY); setSystemMessage(null); }} className="mt-8 px-6 py-2 bg-gray-800 rounded-full text-sm hover:bg-gray-700 border border-gray-700">Ä°ptal Et</button></div>);
            if (gameState === GAME_STATES.MATCH_FOUND) return (<div className="flex flex-col items-center justify-center h-[80vh] animate-bounce-in"><div className="bg-gradient-to-br from-green-500 to-emerald-700 p-6 rounded-full mb-6 shadow-2xl shadow-green-500/30"><Icon name="check" size={64} className="text-white" /></div><h2 className="text-4xl font-bold text-white mb-2">BaÄŸlantÄ± Kuruldu!</h2><div className="bg-gray-800/80 p-6 rounded-xl border border-gray-700 mt-6 text-center backdrop-blur-sm max-w-md"><div className="flex flex-col items-center gap-2"><Icon name="lock" className="text-pink-500" size={32} /><h3 className="text-2xl font-black text-white mb-2">Seviye Gizlendi</h3><p className="text-gray-300 text-sm">SÄ±rayla konuÅŸma baÅŸladÄ±.</p></div></div></div>);
            if (gameState === GAME_STATES.GUESS_LEVEL) return (<div className="max-w-2xl mx-auto p-6 text-center h-[80vh] flex flex-col justify-center"><h2 className="text-3xl font-bold text-white mb-6">SÃ¼re Doldu!</h2><div className="space-y-3 max-w-md mx-auto w-full">{MATCH_LEVELS.map((level) => (<button key={level.id} onClick={() => { setGuessedLevel(level); setGameState(GAME_STATES.GUESS_CRITERIA); }} className="w-full bg-gray-800 hover:bg-gray-700 border border-gray-700 p-4 rounded-xl flex justify-between items-center group"><span className={`text-lg font-bold ${level.color}`}>{level.label}</span><span className="text-gray-500 text-xs">SeÃ§ &rarr;</span></button>))}</div></div>);
            if (gameState === GAME_STATES.GUESS_CRITERIA) return (<div className="max-w-4xl mx-auto p-6 pb-20"><h2 className="text-3xl font-bold text-center text-white mb-2">KanÄ±tÄ±n Ne?</h2><p className="text-center text-gray-400 mb-4">"{guessedLevel.label}" iÃ§in {guessedLevel.limit === 99 ? <span className="text-green-400 font-bold ml-1">SINIRSIZ</span> : <span className="text-pink-500 font-bold ml-1">{guessedLevel.limit} ADET</span>} ortak Ã¶zellik seÃ§ebilirsin.</p>{systemMessage && <div className="text-center text-red-500 font-bold mb-4">{systemMessage}</div>}<div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-8">{QUESTIONS.map((q) => (<button key={q.id} onClick={() => handleGuessToggle(q.id)} className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all ${guesses[q.id] ? 'bg-pink-500/20 border-pink-500 text-pink-400' : 'bg-gray-800 border-gray-700 text-gray-500 hover:border-gray-600'}`}><Icon name={q.iconName} size={18} /><span className="text-xs font-medium text-center">{q.label.split('?')[0]}</span></button>))}</div><div className="flex justify-center"><button onClick={finalizeScore} className="bg-gradient-to-r from-pink-600 to-violet-600 px-12 py-4 rounded-full text-white font-bold text-xl hover:scale-105 transition-transform">SonuÃ§larÄ± GÃ¶r</button></div></div>);
            if (gameState === GAME_STATES.RESULT) return (<div className="max-w-4xl mx-auto p-6 pb-20"><div className="text-center mb-8"><h2 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600 mb-6">YÃœZLEÅME</h2><div className="relative w-40 h-40 mx-auto"><svg viewBox="0 0 36 36" className="circular-chart"><path className="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path className="circle" strokeDasharray={`${Math.min(score, 100)}, 100`} stroke={score >= 70 ? "#10B981" : score >= 40 ? "#F59E0B" : "#EF4444"} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /></svg><div className="absolute inset-0 flex flex-col items-center justify-center"><span className="text-3xl font-black text-white">{score}</span><span className="text-[10px] text-gray-400 uppercase tracking-widest">PUAN</span></div></div></div><div className="flex flex-col md:flex-row justify-center gap-6 mt-8 items-center mb-10"><div className="bg-gray-800 p-6 rounded-2xl border border-gray-700 min-w-[200px] text-center"><p className="text-gray-500 text-xs uppercase">Tahminin</p><p className={`text-xl font-bold ${guessedLevel?.color}`}>{guessedLevel?.label}</p></div><div className="bg-gray-800 p-6 rounded-2xl border border-gray-700 min-w-[200px] text-center relative overflow-hidden"><div className="absolute top-0 right-0 bg-pink-600 text-white text-[10px] px-2 py-1 rounded-bl">GERÃ‡EK</div><p className="text-gray-500 text-xs uppercase">Algoritma</p><p className={`text-xl font-bold ${matchLevel.color}`}>{matchLevel.label}</p></div></div><div className="bg-gray-900/50 p-4 rounded-xl border border-gray-800 mb-8 text-center"><h4 className="text-gray-400 text-sm mb-3">Ortak NoktalarÄ±nÄ±z</h4><div className="flex flex-wrap justify-center gap-2">{sharedCategories.length > 0 ? sharedCategories.map(catId => { const q = QUESTIONS.find(q => q.id === catId); return <span key={catId} className="bg-green-900 text-green-200 px-3 py-1 rounded-full text-xs border border-green-700">{q.label.split('?')[0]}: {userProfile[catId]}</span> }) : <span className="text-gray-500 text-sm">HiÃ§ ortak noktanÄ±z yok.</span>}</div></div><div className="flex flex-col gap-4 justify-center items-center mt-8">{!isUnlimitedChat && (<button onClick={shareResults} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold flex items-center gap-2 shadow-lg"><Icon name="send" size={20} /> SonuÃ§larÄ± Partnere GÃ¶nder</button>)}{isUnlimitedChat && (<button onClick={() => setGameState(GAME_STATES.CHAT)} className="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full font-bold flex items-center gap-2 shadow-lg"><Icon name="message-circle" size={20} /> Sohbete Devam Et</button>)}<button onClick={() => { setGameState(GAME_STATES.LOBBY); setGameId(null); setMessages([]); setQuestionsLeft(3); setCurrentTurn(null); }} className="bg-gradient-to-r from-pink-500 to-violet-600 text-white px-8 py-3 rounded-full font-bold text-lg shadow-lg hover:scale-105 transition-all">Yeni Bir Åans Dene</button></div></div>);
            if (gameState === GAME_STATES.INBOX) return (<div className="max-w-2xl mx-auto p-6 h-[80vh]"><div className="flex items-center gap-4 mb-8"><button onClick={() => setGameState(GAME_STATES.LOBBY)} className="p-2 bg-gray-800 rounded-full flex items-center justify-center"><Icon name="arrow-left" /></button><h2 className="text-3xl font-bold">Gelen Kutusu</h2></div><div className="space-y-4 overflow-y-auto h-full pb-20">{inboxGames.length === 0 ? <p className="text-gray-500 text-center">HenÃ¼z mesaj yok.</p> : inboxGames.map(g => { const isP1 = g.player1.userId === user.uid; const partner = isP1 ? g.player2.profile : g.player1.profile; return (<div key={g.id} onClick={() => openInboxGame(g)} className="bg-gray-800 p-4 rounded-xl border border-gray-700 flex justify-between items-center cursor-pointer hover:border-pink-500 transition-colors"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center"><Icon name="user" /></div><div><h4 className="font-bold text-white">{partner.name} ({partner.age})</h4><p className="text-xs text-gray-400">Sohbete Devam Et</p></div></div><Icon name="chevron-right" className="text-gray-500" /></div>) })}</div></div>);
            if (gameState === GAME_STATES.CHAT) {
                const isMyTurn = currentTurn === user.uid;
                const myMessagesCount = messages.filter(m => m.senderId === user.uid && m.type !== 'result_card').length;
                const remainingRights = 3 - myMessagesCount;
                return (
                    <div className="h-[85vh] flex flex-col max-w-3xl mx-auto">
                        <div className="bg-gray-800 p-4 rounded-t-xl border-b border-gray-700 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                {isUnlimitedChat && <button onClick={() => setGameState(GAME_STATES.INBOX)} className="mr-2 text-gray-400 hover:text-white flex items-center justify-center"><Icon name="arrow-left" /></button>}
                                <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg"><Icon name="user" size={20} className="text-white" /></div><div><h3 className="font-bold text-white">{opponentProfile.name} ({opponentProfile.age})</h3>{!isUnlimitedChat && <span className="text-xs text-gray-400 flex items-center gap-1"><Icon name="lock" size={10} /> BaÄŸ Seviyesi Gizli</span>}</div>
                            </div>
                            {!isUnlimitedChat && (<div className="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded-full border border-gray-700"><Icon name="message-circle" size={14} className="text-pink-500" /><span className="text-sm font-bold text-gray-300">Hak: {remainingRights}/3</span></div>)}
                        </div>
                        <div className="flex-1 bg-gray-900/50 overflow-y-auto p-4 space-y-4 scrollbar-thin relative">
                            {systemMessage && <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-red-600/90 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-xl z-50 animate-bounce">{systemMessage}</div>}
                            {messages.map((msg, idx) => {
                                if (msg.type === 'result_card') return (<div key={idx} className="flex justify-center my-4"><div className="bg-gray-800 border border-pink-500/50 rounded-xl p-4 w-64 text-center shadow-lg animate-fade-in"><div className="text-xs text-pink-400 font-bold uppercase tracking-widest mb-2">OYUN SONUCU</div><div className="text-3xl font-black text-white mb-1">{msg.data.score} <span className="text-xs text-gray-400">PUAN</span></div><div className="text-sm text-gray-300 mb-2">{msg.data.guessedLevel}</div></div></div>);
                                const isMe = msg.senderId === user.uid;
                                return (<div key={idx} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-2xl ${isMe ? 'bg-pink-600 text-white rounded-tr-none' : 'bg-gray-700 text-gray-200 rounded-tl-none'}`}>{msg.text}</div></div>);
                            })}
                            <div ref={chatEndRef} />
                        </div>
                        <div className="p-4 bg-gray-800 rounded-b-xl border-t border-gray-700">
                            {!isUnlimitedChat && (<div className="mb-2 text-center">{isMyTurn ? <span className="text-green-400 text-xs font-bold animate-pulse">â— SÄ±ra Sende!</span> : <span className="text-gray-500 text-xs font-bold">â—‹ KarÅŸÄ± taraf yazÄ±yor...</span>}</div>)}
                            <div className="flex gap-2 items-center"><input type="text" disabled={!isUnlimitedChat && !isMyTurn} value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && sendMessage()} placeholder="MesajÄ±nÄ± yaz..." className={`flex-1 bg-gray-900 border border-gray-700 rounded-full px-6 py-3 text-white outline-none ${!isUnlimitedChat && !isMyTurn && 'opacity-50'}`} /><button disabled={!isUnlimitedChat && !isMyTurn} onClick={sendMessage} className={`bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-110 ${!isUnlimitedChat && !isMyTurn && 'opacity-50 cursor-not-allowed'}`}><Icon name="send" size={20} /></button></div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MysteryConnectionGame />);
    </script>
</body>
</html>


